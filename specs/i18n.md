# Internationalization (i18n) Specification

## Overview

Multi-language support for Catchpoint PWA. Initial languages: English (default) and French.
Language detection follows system/browser preference with manual override.

## User Story

**As a** user  
**I want to** use the app in my preferred language  
**So that** I can understand all UI elements naturally

## Requirements

### Language Detection (Priority Order)

1. **User preference** (if explicitly set in Settings)
2. **System/browser language** (`navigator.language` or `navigator.languages[0]`)
3. **Fallback** to English (`en`)

```typescript
function getInitialLanguage(): "en" | "fr" {
  // Check user preference first
  const stored = localStorage.getItem("settings-storage");
  if (stored) {
    const settings = JSON.parse(stored);
    if (settings.state?.language) {
      return settings.state.language;
    }
  }

  // Detect system language
  const systemLang = navigator.language || navigator.languages?.[0] || "en";
  const langCode = systemLang.split("-")[0].toLowerCase();

  // Return French if detected, otherwise English
  return langCode === "fr" ? "fr" : "en";
}
```

### Supported Languages

| Code | Name    | Native Name |
| ---- | ------- | ----------- |
| `en` | English | English     |
| `fr` | French  | Francais    |

### Translation Structure

```
src/
  i18n/
    index.ts          # i18n setup and provider
    en.json           # English translations
    fr.json           # French translations
    types.ts          # TypeScript types for translations
```

### Translation Keys (Namespace Structure)

```json
{
  "common": {
    "save": "Save",
    "cancel": "Cancel",
    "delete": "Delete",
    "edit": "Edit",
    "close": "Close",
    "loading": "Loading...",
    "error": "Error",
    "success": "Success",
    "confirm": "Confirm",
    "back": "Back"
  },
  "nav": {
    "home": "Home",
    "log": "Log",
    "map": "Map",
    "stats": "Stats",
    "settings": "Settings"
  },
  "home": {
    "title": "Catchpoint",
    "catchButton": "FISH ON!",
    "catchSuccess": "Catch logged!",
    "recentCatches": "Recent Catches",
    "noCatches": "No catches yet. Tap the button when you catch a fish!"
  },
  "log": {
    "title": "Catch Log",
    "empty": "No catches yet",
    "filter": "Filter",
    "sort": "Sort",
    "deleteConfirm": "Delete this catch?",
    "catches": "{{count}} catch",
    "catches_plural": "{{count}} catches"
  },
  "map": {
    "title": "Map",
    "yourLocation": "Your location",
    "catchLocation": "Catch location",
    "cluster": "{{count}} catches"
  },
  "stats": {
    "title": "Statistics",
    "timeRange": {
      "7d": "7 Days",
      "30d": "30 Days",
      "1y": "1 Year",
      "all": "All Time"
    },
    "cards": {
      "totalCatches": "Total Catches",
      "avgWeight": "Avg. Weight",
      "biggestCatch": "Biggest Catch",
      "bestDay": "Best Day"
    },
    "charts": {
      "catchesOverTime": "Catches Over Time",
      "speciesBreakdown": "Species Breakdown",
      "bestHours": "Best Fishing Hours"
    },
    "noData": "Not enough data for this time range"
  },
  "settings": {
    "title": "Settings",
    "sections": {
      "preferences": "Preferences",
      "data": "Data",
      "pwa": "App",
      "about": "About"
    },
    "language": "Language",
    "theme": "Theme",
    "themeOptions": {
      "light": "Light",
      "dark": "Dark",
      "system": "System"
    },
    "weightUnit": "Weight Unit",
    "lengthUnit": "Length Unit",
    "exportCsv": "Export to CSV",
    "loadTestData": "Load Test Data",
    "clearData": "Clear All Data",
    "clearDataConfirm": "Are you sure? This cannot be undone.",
    "installApp": "Install App",
    "storageUsed": "Storage Used",
    "version": "Version",
    "licenses": "Licenses",
    "privacy": "Privacy Policy"
  },
  "catch": {
    "species": "Species",
    "weight": "Weight",
    "length": "Length",
    "notes": "Notes",
    "photo": "Photo",
    "location": "Location",
    "weather": "Weather",
    "timestamp": "Date & Time",
    "addPhoto": "Add Photo",
    "removePhoto": "Remove Photo",
    "unknownSpecies": "Unknown Species"
  },
  "weather": {
    "pending": "Fetching weather...",
    "unavailable": "Weather unavailable",
    "temp": "{{temp}}{{unit}}"
  },
  "errors": {
    "locationDenied": "Location access denied",
    "locationUnavailable": "Location unavailable",
    "weatherFailed": "Could not fetch weather",
    "exportFailed": "Export failed",
    "saveFailed": "Could not save",
    "deleteFailed": "Could not delete"
  },
  "pwa": {
    "installPrompt": "Install Catchpoint for the best experience",
    "installed": "App installed",
    "offline": "You're offline",
    "online": "Back online"
  }
}
```

### Implementation Approach

#### Option A: Lightweight Custom Solution (Recommended)

For a small app with 2 languages, a simple context-based solution:

```typescript
// src/i18n/index.ts
import { createContext, useContext, ReactNode } from 'react';
import en from './en.json';
import fr from './fr.json';

type Language = 'en' | 'fr';
type Translations = typeof en;

const translations: Record<Language, Translations> = { en, fr };

interface I18nContextType {
  t: (key: string, params?: Record<string, string | number>) => string;
  language: Language;
  setLanguage: (lang: Language) => void;
}

const I18nContext = createContext<I18nContextType | null>(null);

export function I18nProvider({ children }: { children: ReactNode }) {
  // Get language from settings store
  const { language, setLanguage } = useSettingsStore();

  const t = (key: string, params?: Record<string, string | number>): string => {
    const keys = key.split('.');
    let value: unknown = translations[language];

    for (const k of keys) {
      if (value && typeof value === 'object') {
        value = (value as Record<string, unknown>)[k];
      } else {
        return key; // Fallback to key if not found
      }
    }

    if (typeof value !== 'string') return key;

    // Replace params: {{param}} -> value
    if (params) {
      return value.replace(/\{\{(\w+)\}\}/g, (_, p) =>
        String(params[p] ?? `{{${p}}}`)
      );
    }

    return value;
  };

  return (
    <I18nContext.Provider value={{ t, language, setLanguage }}>
      {children}
    </I18nContext.Provider>
  );
}

export function useTranslation() {
  const context = useContext(I18nContext);
  if (!context) throw new Error('useTranslation must be used within I18nProvider');
  return context;
}
```

#### Option B: react-i18next

For future extensibility to more languages:

```bash
npm install react-i18next i18next i18next-browser-languagedetector
```

### Settings Store Update

```typescript
interface SettingsStore {
  // Existing
  theme: "light" | "dark" | "system";
  weightUnit: "lbs" | "kg";
  lengthUnit: "in" | "cm";

  // New
  language: "en" | "fr" | "system";

  // Actions
  setLanguage: (lang: "en" | "fr" | "system") => void;
  // ... existing actions
}
```

### Settings UI Addition

Add language selector to Settings page under Preferences:

```
┌─────────────────────────────────────┐
│ PREFERENCES                         │
│ ┌─────────────────────────────────┐ │
│ │ Language           [System v]   │ │  <-- NEW
│ │ Theme              [Light v]    │ │
│ │ Weight Unit        [lbs v]      │ │
│ │ Length Unit        [in v]       │ │
│ └─────────────────────────────────┘ │
```

Options:

- **System** (default) - follows device language
- **English**
- **Francais**

### Preventing Flash of Wrong Language

Similar to theme, add blocking script in `index.html`:

```html
<script>
  (function () {
    // Detect language early for any server-rendered or initial content
    window.__INITIAL_LANG__ = (() => {
      const stored = localStorage.getItem("settings-storage");
      if (stored) {
        try {
          const settings = JSON.parse(stored);
          const lang = settings.state?.language;
          if (lang && lang !== "system") return lang;
        } catch {}
      }
      const sys = (navigator.language || "en").split("-")[0];
      return sys === "fr" ? "fr" : "en";
    })();
    document.documentElement.setAttribute("lang", window.__INITIAL_LANG__);
  })();
</script>
```

## Date & Number Formatting

Use `Intl` APIs with detected language:

```typescript
// Date formatting
const formatDate = (date: Date, lang: Language) =>
  new Intl.DateTimeFormat(lang, {
    dateStyle: "medium",
    timeStyle: "short",
  }).format(date);

// Number formatting
const formatNumber = (num: number, lang: Language) =>
  new Intl.NumberFormat(lang).format(num);

// Examples:
// EN: "Jan 15, 2026, 3:45 PM" | "1,234.56"
// FR: "15 janv. 2026, 15:45"  | "1 234,56"
```

## Species List

Species names should also be translated:

```typescript
// src/data/species.ts
export const speciesNames: Record<Language, string[]> = {
  en: ['Bass', 'Trout', 'Pike', 'Carp', 'Catfish', ...],
  fr: ['Bar', 'Truite', 'Brochet', 'Carpe', 'Silure', ...],
};
```

## Acceptance Criteria

- [ ] App detects system language on first launch
- [ ] Language persists when explicitly set
- [ ] "System" option follows device preference
- [ ] All UI text is translated (no hardcoded strings)
- [ ] Date/time formats respect locale
- [ ] Number formats respect locale (decimal separators)
- [ ] Language switch applies immediately (no reload)
- [ ] No flash of wrong language on startup
- [ ] Species dropdown shows translated names
- [ ] Export CSV headers use current language

## Related Specs

- `settings.md` - Language setting UI
- `overview.md` - Data model updates
- `catch-log.md` - Date formatting
- `statistics.md` - Number formatting

## Future Considerations

- Add more languages (Spanish, German, Portuguese)
- RTL support for Arabic
- Translation management (Crowdin, etc.)
- Pluralization rules per language
